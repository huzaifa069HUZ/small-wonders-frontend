<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Small Wonders Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-xl font-bold text-gray-800">Admin Dashboard</h1>
        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">
            Logout
        </button>
    </nav>

    <div class="max-w-6xl mx-auto p-6">

        <!-- Upload Section -->
        <div class="bg-white p-6 rounded-2xl shadow-sm mb-8">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <i data-lucide="upload-cloud" class="w-5 h-5 text-blue-500"></i> Upload New Photo
            </h2>

            <form id="upload-form" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Photo</label>
                        <input type="file" id="file-input" accept="image/*" required
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="category-input"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="events">Events</option>
                            <option value="classroom">Classroom</option>
                            <option value="sports">Sports</option>
                            <option value="trips">School Trips</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Caption (Optional)</label>
                    <input type="text" id="caption-input" placeholder="e.g. Annual Sports Day 2026"
                        class="w-full p-2 border rounded-lg">
                </div>

                <button type="submit" id="upload-btn"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 w-full md:w-auto font-semibold flex items-center justify-center gap-2">
                    <span id="btn-text">Upload to Gallery</span>
                    <span id="btn-loader"
                        class="hidden animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent"></span>
                </button>
            </form>
            <p id="status-msg" class="mt-4 text-center text-sm font-medium"></p>
        </div>

        <!-- Gallery Management -->
        <h2 class="text-xl font-bold mb-4">Current Gallery Images</h2>
        <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Images will be loaded here -->
            <div class="animate-pulse bg-gray-200 h-48 rounded-xl"></div>
            <div class="animate-pulse bg-gray-200 h-48 rounded-xl"></div>
            <div class="animate-pulse bg-gray-200 h-48 rounded-xl"></div>
        </div>

    </div>

    <script>
        lucide.createIcons();
        const uploadForm = document.getElementById('upload-form');
        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const categoryInput = document.getElementById('category-input');
        const captionInput = document.getElementById('caption-input');
        const statusMsg = document.getElementById('status-msg');
        const galleryGrid = document.getElementById('gallery-grid');

        // 1. Auth Check
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                loadGallery(); // Load images only if logged in
            }
        });

        // 2. Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });

        // 3. Upload Logic
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = fileInput.files[0];
            if (!file) return;

            // UI Loading State
            uploadBtn.disabled = true;
            document.getElementById('btn-text').innerText = 'Uploading...';
            document.getElementById('btn-loader').classList.remove('hidden');
            statusMsg.innerText = '';
            statusMsg.className = '';

            try {
                // Step A: Upload to Vercel Blob via our API
                // We send the file directly as the body
                const filename = Date.now() + '-' + file.name;
                const response = await fetch(`/api/upload-photo?filename=${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    body: file
                });

                if (!response.ok) throw new Error('Upload failed');
                const blobData = await response.json();
                const imageUrl = blobData.url;

                // Step B: Save Metadata to Firestore
                await db.collection('gallery').add({
                    url: imageUrl,
                    category: categoryInput.value,
                    caption: captionInput.value || '',
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Success
                statusMsg.innerText = '✅ Photo uploaded successfully!';
                statusMsg.className = 'text-green-600 text-center mt-4';
                uploadForm.reset();
                loadGallery(); // Refresh list

            } catch (error) {
                console.error(error);
                statusMsg.innerText = '❌ Error: ' + error.message;
                statusMsg.className = 'text-red-600 text-center mt-4';
            } finally {
                uploadBtn.disabled = false;
                document.getElementById('btn-text').innerText = 'Upload to Gallery';
                document.getElementById('btn-loader').classList.add('hidden');
            }
        });

        // 4. Load Gallery
        async function loadGallery() {
            galleryGrid.innerHTML = '';

            try {
                const snapshot = await db.collection('gallery').orderBy('uploadedAt', 'desc').get();

                if (snapshot.empty) {
                    galleryGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No photos found.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = 'relative group rounded-xl overflow-hidden shadow-sm bg-white aspect-square';
                    card.innerHTML = `
                        <img src="${data.url}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-4">
                            <span class="text-white text-xs font-bold uppercase mb-2">${data.category}</span>
                            <button onclick="deletePhoto('${doc.id}', '${data.url}')" class="bg-red-500 text-white text-xs px-3 py-2 rounded-lg hover:bg-red-600 flex items-center justify-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Delete
                            </button>
                        </div>
                    `;
                    galleryGrid.appendChild(card);
                });
                lucide.createIcons();

            } catch (error) {
                console.error("Error loading gallery:", error);
                galleryGrid.innerHTML = '<p class="text-red-500">Failed to load images.</p>';
            }
        }

        // 5. Delete Photo
        window.deletePhoto = async (docId, url) => {
            if (!confirm('Are you sure you want to delete this photo?')) return;

            try {
                // Delete from Firestore
                await db.collection('gallery').doc(docId).delete();
                // (Optional) We could also delete from Blob store, but that requires a different API call.
                // For now, removing from DB is enough to hide it from the site.

                loadGallery();
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        };
    </script>
</body>

</html>